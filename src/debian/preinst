#!/bin/bash
# preinst script for test
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <new-preinst> `install'
#        * <new-preinst> `install' <old-version>
#        * <new-preinst> `upgrade' <old-version>
#        * <old-preinst> `abort-upgrade' <new-version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package

backup_lxccu () {
    if [ -f /opt/lxccu_backup.tar.gz ]; then
        # maybe save it on purge
        rm /opt/lxccu_backup.tar.gz
        rm /opt/lxccu_config_backup
    fi
    if lxc-info -n lxccu | grep -qs "RUNNING"
    then
        echo "shutdown lxccu"
        # @TODO when there is a rootfs symlink -> change to shutdown but test it
        lxc-stop -n lxccu  
#2>&1 > /dev/null
        echo -n "waiting for lxccu shutdown"
        timeout=30
        while [ $timeout -gt 0 ]
        do
            echo -n "."
            timeout=$(($timeout-1));sleep 1
            if lxc-info -n lxccu | grep -qs "STOPPED"
            then
                timeout=0
            fi
        done
        echo ""
        echo "lxccu shutdown complete"
    fi
    echo "backup lxccu at /opt"
    cd /var/lib/lxc/lxccu/root
    tar czf /opt/lxccu_backup.tar.gz usr/local
    cp /var/lib/lxc/lxccu/config /opt/lxccu_config_backup

    cd /var/lib/lxc/
    tar czf /opt/lxccu_prev_backup_`date +%s`.tar.gz lxccu/
}

#########
#
#
#   bridge functions start
#
#
#########
NETWORK_FILE="/etc/network/interfaces"

_backup_networkconfig_file() {
    cur_date=$(date "+%y_%m_%d_%H-%M")
    cp $NETWORK_FILE /etc/network/interfaces_${cur_date}
}

_bridge_exists() {
    local count=$(cat $NETWORK_FILE | grep "bridge-ports" | wc -l)
    echo $count
}

_has_static_ip() {
    echo $(cat $NETWORK_FILE | grep "eth0 inet static" | wc -l)
}

_is_raspinetmod_installed() {
    dpkg-query -W --showformat='${Status}\n' raspberrypi-net-mods > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        echo 1
    else
        echo 0
    fi
}

_create_static_bridge() {
    sed -i "s/iface eth0 inet static/#iface eth0 inet static\\n\\nauto lxccubr0\\niface lxccubr0 inet static\\n\\tbridge-ports eth0/g" $NETWORK_FILE
    echo "" >> $NETWORK_FILE
}

_create_dhcp_bridge() {
    if [ `_is_raspinetmod_installed` -eq 1 ]; then 
        echo -e "\\nauto lxccubr0\\niface lxccubr0 inet dhcp\\n\\tbridge-ports eth0" >> $NETWORK_FILE
    else
        sed -i "s/iface eth0 inet dhcp/#iface eth0 inet dhcp\\n\\nauto lxccubr0\\niface lxccubr0 inet dhcp\\n\\tbridge-ports eth0/g" $NETWORK_FILE
        # beim akuellen rapsbian steht an stelle von dhcp standardmaessig manual
        sed -i "s/iface eth0 inet manual/#iface eth0 inet dhcp\\n\\nauto lxccubr0\\niface lxccubr0 inet dhcp\\n\\tbridge-ports eth0/g" $NETWORK_FILE
    fi
    echo "" >> $NETWORK_FILE
}

_create_bridge() {
    _backup_networkconfig_file
    if [ `_has_static_ip` -eq 1 ]; then
        echo "creating STATIC bridge"
        _create_static_bridge
    else
        echo "creating DHCP bridge"
        _create_dhcp_bridge
    fi
}
#########
#
#
#   bridge functions end
#
#
#########

case "$1" in
    install)
        # mount cgroup
        if [ $(mount | grep cgroup | wc -l) ]; then
            cgroup_mounted=$(cat /etc/fstab | grep cgroup | wc -l)
            if [ $cgroup_mounted -eq 0 ]; then
                echo "lxc /sys/fs/cgroup cgroup defaults 0 0" >> /etc/fstab
            fi
# wird bei jessie nach der Installation von lxc gemountet
#            mount -a > /dev/null 2>&1
        fi

        if [ `_bridge_exists` -eq 0 ]; then
            _create_bridge
            ifup lxccubr0
        fi 
    ;;

    upgrade)
        backup_lxccu
    ;;

    abort-upgrade)
    ;;

    *)
        echo "preinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
