#!/bin/sh
# postinst script for test
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package
BACKTITLE="LXCCU"
SETUP_TITLE="SETUP"

PATCH=$(which patch)
TAR=$(which tar)
LXC_CHECKCONFIG=$(which lxc-checkconfig)
LXC_CREATE=$(which lxc-create)
LXC_LIST=$(which lxc-list)
WGET=$(which wget)
PV=$(which pv)

LXCCU_FW_VERSION="2.7.17"
ROOT_PATH="/var/lib/lxccu/"

case "$1" in
    configure)
		# download fw
		LXCU_FW_ROOTFS_URL="https://dl.dropboxusercontent.com/s/lctfiakv5k4zfi1/HM-CCU2-2.7.17-rootfs.tar.gz?dl=1"
		LXCU_FW="${ROOT_PATH}container/HM-CCU2-${LXCCU_FW_VERSION}-rootfs.tar.gz"
		echo "Downloading firmware"
		wget "$LXCU_FW_ROOTFS_URL" --output-document="$LXCU_FW" 2>&1
		if [ ! -f "$LXCU_FW" ]; then
			echo "Can not download firmware. Are you connected to the internet?"
			exit 1
		fi
		# extract fw
		LXCU_FW_ROOTFS="${ROOT_PATH}container/fs/"
		echo "Extracting firmware"
		tar xzf $LXCU_FW -C $LXCU_FW_ROOTFS
		# patch fw
		cd $LXCU_FW_ROOTFS 
		echo "apply patch"
		patch --input "${ROOT_PATH}source/patches/lxccu-${LXCCU_FW_VERSION}.patch" -p1
		# apply scripts
		cd $LXCU_FW_ROOTFS 
		echo "apply script"
		sh "${ROOT_PATH}source/lxccu-${LXCCU_FW_VERSION}.sh"
		# sdcard
		mkdir -p /media/sd-lxccu/
		touch /media/sd-lxccu/.initialised
		# prepare configure file
		#TEMP$(<${ROOT_PATH}source/lxc-config/config-${LXCCU_FW_VERSION})
		dialog --backtitle "$BACKTITLE" \
			--title $CONFIG_TITLE \
			--radiolist "Select a network bridge:" 10 40 4 \
				`ip -o link | grep -v "lo" | awk '{split($0,a,":"); nic=a[2]; gsub(" ","",nic); s="off"; if (FNR==1) s="on"; print FNR" "nic" "s}'` 2>$OUTPUT
		response=$?
		case $response in
			0)
				#echo "select input: $INPUT"
				BRIDGE_DEVICE=`ip -o link | grep -v "lo" | head -n $INPUT | tail -n 1 | awk '{split($0,a," "); nic=a[2]; print substr(nic,0,length(nic));}'`
				;;
			*)
				exit 1
		esac
		TEMP= <<EOF
lxc.mount.entry = proc proc proc nodev,noexec,nosuid 0 0
lxc.mount.entry = sysfs sys sysfs defaults  0 0
lxc.mount.entry = varfs var tmpfs defaults,size=196M 0 0
#lxc.mount.entry = devpts dev/pts devpts nosuid,mode=0620,ptmxmode=000,newinstance 0 0
lxc.mount.entry = devpts dev/pts devpts defaults,newinstance 0 0
lxc.mount.entry = /media/sd-lxccu  media/sd-mmcblk0/ none defaults,bind 0 0

lxc.tty = 1
lxc.pts = 1
lxc.cgroup.devices.deny = a

# /dev/null and zero
lxc.cgroup.devices.allow = c 1:3 rwm
lxc.cgroup.devices.allow = c 1:5 rwm

# consoles
lxc.cgroup.devices.allow = c 5:1 rwm
lxc.cgroup.devices.allow = c 5:0 rwm
lxc.cgroup.devices.allow = c 4:0 rwm
lxc.cgroup.devices.allow = c 4:1 rwm

# /dev/{,u}random
lxc.cgroup.devices.allow = c 1:9 rwm
lxc.cgroup.devices.allow = c 1:8 rwm

# /dev/pts/* - pts namespaces are "coming soon"
lxc.cgroup.devices.allow = c 136:* rwm
lxc.cgroup.devices.allow = c 5:2 rwm

#lxc.cgroup.devices.allow = c 136:* rwm # pts
#lxc.cgroup.devices.allow = c 254:0 rwm # rtc
#lxc.cgroup.devices.allow = c 5:* rwm
#lxc.cgroup.devices.allow = c 4:* rwm # ttyXX
#lxc.cgroup.devices.allow = c 1:* rwm
#lxc.cgroup.devices.allow = b 7:* rwm # loop
#lxc.cgroup.devices.allow = b 1:* rwm # ram

lxc.utsname = lxccu
lxc.network.type = veth
lxc.network.flags = up
lxc.network.link = $BRIDGE_DEVICE
lxc.network.hwaddr = 4a:49:43:49:79:bf
lxc.rootfs = /var/lib/lxccu/container/fs
EOF
		echo "$TEMP" > "${ROOT_PATH}container/config"
		# add container
		lxc-create -n lxccu -f "${ROOT_PATH}container/config" -t none
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
